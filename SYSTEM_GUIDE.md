# 📚 מדריך מערכת השידוך - הסבר מלא

## 🎯 מטרת המערכת

המערכת נועדה **להתאים אוטומטית בין חיילים (students) למתנדבים (users)** על בסיס קריטריונים כמו שפה, מיקום גיאוגרפי, והעדפות אישיות.

---

## 📤 שלב 1: העלאת קבצי Excel

### מבנה הקבצים הנדרש

#### גיליון חיילים (students)
| עמודה בעברית | עמודה באנגלית | חובה? | הערות |
|--------------|---------------|-------|-------|
| שם פרטי | first_name | ✅ | |
| שם משפחה | last_name | ✅ | |
| שם מלא | full_name | ✅ | אפשר במקום שם פרטי + משפחה |
| אימייל | email | ❌ | אם חסר - נוצר אוטומטית |
| טלפון נייד / טלפון | phone | ❌ | |
| עיר מגורים / עיר | city | ✅ | **חשוב לרשום נכון!** |
| שפת אם / שפות | native_language | ✅ | |
| מין | gender | ❌ | |
| בקשות מיוחדות | special_requests | ❌ | |
| חיל | military_unit | ❌ | |
| מקום שירות | service_location | ❌ | |
| מזהה איש קשר | contact_id | ❌ | |
| רכז | coordinator | ❌ | |

#### גיליון מתנדבים (users)
| עמודה בעברית | עמודה באנגלית | חובה? | הערות |
|--------------|---------------|-------|-------|
| שם פרטי | first_name | ✅ | |
| שם משפחה | last_name | ✅ | |
| אימייל | email | ❌ | אם חסר - נוצר אוטומטית |
| טלפון נייד / טלפון | phone | ❌ | |
| עיר מגורים / עיר | city | ✅ | **חשוב לרשום נכון!** |
| שפת אם / שפות | native_language | ✅ | |
| מין | gender | ❌ | |
| האם פעיל במלגה / מלגה פעילה | scholarship_active | ❌ | ברירת מחדל: כן |

> **🎯 קיבולת אוטומטית!**
> 
> אין צורך להגדיר `capacity_max` - הוא נקבע **אוטומטית** לפי `scholarship_active`:
> - ✅ **פעיל במלגה** = 4 מקומות לחיילים
> - ❌ **לא פעיל במלגה** = 2 מקומות לחיילים

---

## 🏙️ שלב 2: בעיית הערים - נרמול שמות

### ⚠️ הבעיה
כאשר ערים רשומות בצורות שונות, המערכת לא יכולה להתאים אותן:

```
❌ בעייתי:
- "תל אביב" ≠ "תל-אביב" ≠ "ת"א" ≠ "תל אביב יפו"
- "ירושלים" ≠ "ירושליים" ≠ "י-ם"
- "באר שבע" ≠ "באר-שבע" ≠ "ב"ש"
```

### ✅ הפתרון - נרמול ערים

המערכת צריכה טבלת מיפוי ערים. הנה הצעה:

#### טבלת נרמול ערים מומלצת

| צורות אפשריות | שם מתוקנן | אזור |
|---------------|-----------|------|
| תל אביב, תל-אביב, ת"א, תל אביב יפו, תל אביב-יפו | תל אביב | מרכז |
| ירושלים, ירושליים, י-ם, ירושלם | ירושלים | ירושלים |
| חיפה, חיפה והקריות | חיפה | צפון |
| באר שבע, באר-שבע, ב"ש, באר שבע | באר שבע | דרום |
| פתח תקווה, פתח-תקווה, פ"ת, פתח תקוה | פתח תקווה | מרכז |
| ראשון לציון, ראשל"צ, ראשון-לציון | ראשון לציון | מרכז |
| נתניה, נתניא | נתניה | שרון |
| אשדוד | אשדוד | דרום |
| אשקלון | אשקלון | דרום |
| הרצליה, הרצלייה | הרצליה | שרון |
| רמת גן, רמת-גן, ר"ג | רמת גן | מרכז |
| בני ברק, בני-ברק, ב"ב | בני ברק | מרכז |
| חולון | חולון | מרכז |
| בת ים, בת-ים | בת ים | מרכז |
| כפר סבא, כפר-סבא, כ"ס | כפר סבא | שרון |
| רעננה, רעננא | רעננה | שרון |
| הוד השרון, הוד-השרון | הוד השרון | שרון |
| מודיעין, מודיעין-מכבים-רעות | מודיעין | מרכז |
| רחובות | רחובות | מרכז |
| נס ציונה, נס-ציונה | נס ציונה | מרכז |
| לוד | לוד | מרכז |
| רמלה | רמלה | מרכז |
| עפולה | עפולה | צפון |
| נצרת, נצרת עילית | נצרת | צפון |
| טבריה, טבריא | טבריה | צפון |
| צפת, צפד | צפת | צפון |
| עכו, עכו | עכו | צפון |
| נהריה, נהרייה | נהריה | צפון |
| קריית שמונה, קרית שמונה | קריית שמונה | צפון |
| אילת | אילת | דרום |
| דימונה | דימונה | דרום |
| ערד | ערד | דרום |

### 🔧 איך לתקן ערים בקובץ Excel לפני העלאה

#### אפשרות 1: Find & Replace ב-Excel
1. פתח את קובץ ה-Excel
2. לחץ `Ctrl + H`
3. החלף צורות שונות לצורה אחידה:
   - החלף `ת"א` ב-`תל אביב`
   - החלף `י-ם` ב-`ירושלים`
   - וכו'

#### אפשרות 2: נוסחת VLOOKUP
```excel
=VLOOKUP(A2, טבלת_נרמול, 2, FALSE)
```

#### אפשרות 3: בדיקה ידנית
לפני העלאה, בדוק את רשימת הערים הייחודיות:
1. סנן את עמודת העיר
2. בדוק שכל הערים רשומות נכון
3. תקן ידנית

---

## 🎯 שלב 3: אלגוריתם ההתאמה

### 🔄 איך עובד האלגוריתם?

```
┌─────────────────────────────────────────────────────────────────┐
│  שלב 1: טעינת נתונים                                            │
│  📊 כל החיילים שלא שובצו (is_matched = false)                   │
│  📊 כל המתנדבים הפעילים עם מקום פנוי                             │
├─────────────────────────────────────────────────────────────────┤
│  שלב 2: חישוב כל האפשרויות                                      │
│  לכל חייל × לכל מתנדב = מחשב ציון התאמה                         │
│  דוגמה: 200 חיילים × 50 מתנדבים = 10,000 חישובים               │
├─────────────────────────────────────────────────────────────────┤
│  שלב 3: סינון ראשוני                                            │
│  ❌ מרחק > 80 ק"מ → נפסל                                        │
│  ❌ ציון < 60% → נפסל                                           │
├─────────────────────────────────────────────────────────────────┤
│  שלב 4: מיון לפי ציון (גבוה לנמוך)                              │
├─────────────────────────────────────────────────────────────────┤
│  שלב 5: הקצאה חמדנית (Greedy Allocation)                        │
│  בוחר את ההתאמות הטובות ביותר תוך שמירה על מגבלות               │
├─────────────────────────────────────────────────────────────────┤
│  שלב 6: שמירת התוצאות בסטטוס "Suggested"                        │
└─────────────────────────────────────────────────────────────────┘
```

### איך המערכת מחשבת ציון התאמה?

```
ציון התחלתי = 0

╔════════════════════════════════════════════════════════════════╗
║                    קריטריוני ניקוד (מעודכן!)                    ║
╠════════════════════════════════════════════════════════════════╣
║ שפת אם זהה                      │ +60 נקודות                  ║
╠════════════════════════════════════════════════════════════════╣
║ 🟢 אותה עיר / עד 15 ק"מ         │ +40 נקודות                  ║
║ 🔵 מרחק עד 30 ק"מ               │ +30 נקודות                  ║
║ 🟡 מרחק עד 50 ק"מ               │ +20 נקודות                  ║
║ 🟠 מרחק עד 80 ק"מ               │ +10 נקודות                  ║
║ 🔴 מרחק מעל 80 ק"מ              │ ❌ לא מותאם                  ║
╠════════════════════════════════════════════════════════════════╣
║ התאמת מין (רק אם יש העדפה!)     │ +15 נקודות                  ║
║ התאמה לבקשות מיוחדות            │ +5 נקודות                   ║
╚════════════════════════════════════════════════════════════════╝

ציון מקסימלי = 100
ציון מינימלי להתאמה = 60 (ניתן לשינוי בהגדרות)
מרחק מקסימלי = 80 ק"מ (ניתן לשינוי בהגדרות)
```

### 🆕 העדפת מין - לוגיקה חכמה

| העדפת החייל | התנהגות |
|------------|---------|
| **"לא חשוב"** / **"לא משנה"** / **ריק** | ❌ לא בודקים מין - אין נקודות ואין קנס |
| **"מתנדב"** / **"זכר"** | ✅ 15 נקודות אם המתנדב זכר |
| **"מתנדבת"** / **"נקבה"** | ✅ 15 נקודות אם המתנדב נקבה |
| **העדפה שלא מתאימה** | ⚠️ הערה בסיבת ההתאמה |

הערכים הבאים נחשבים כ"לא חשוב":
- לא חשוב, לא משנה, לא משונה, לא רלוונטי
- כל אחד, כל אחת, לא ידוע, לא צוין
- ערך ריק (NULL)

### דוגמאות לחישוב

#### דוגמה 1: התאמה מצוינת (100 נקודות)
```
חייל: דוד, תל אביב, רוסית, זכר
מתנדב: אלכסנדר, רמת גן, רוסית, זכר

מרחק: תל אביב ↔ רמת גן = 3.5 ק"מ (דירוג 1)

חישוב:
+ 60 (שפת אם זהה - רוסית)
+ 40 (מרחק עד 15 ק"מ - דירוג 1)
────────
= 100 נקודות ✅
```

#### דוגמה 2: התאמה טובה מאוד (90 נקודות)
```
חייל: מריה, חיפה, רוסית, נקבה
מתנדב: אולגה, נהריה, רוסית, נקבה

מרחק: חיפה ↔ נהריה = 25 ק"מ (דירוג 2)

חישוב:
+ 60 (שפת אם זהה - רוסית)
+ 30 (מרחק עד 30 ק"מ - דירוג 2)
────────
= 90 נקודות ✅
```

#### דוגמה 3: התאמה לא אפשרית
```
חייל: יוסי, אילת, עברית, זכר
מתנדב: משה, תל אביב, עברית, זכר

מרחק: אילת ↔ תל אביב = 350 ק"מ (מעל 80 ק"מ!)

❌ לא מותאם - מרחק גדול מדי
```

### 🆕 תיאור התאמה מפורט

כל התאמה מציגה תיאור מפורט הכולל את **שפות האם של שני הצדדים**:

```
דוגמאות לתיאור:

✅ התאמת שפה:
"שפה: רוסית ✅ | עיר: תל אביב ✅ | מרחק: 5 ק"מ"

❌ ללא התאמת שפה:
"שפה: חייל רוסית | מתנדב אנגלית | עיר: ירושלים ✅"

✅ עם התאמת מין:
"שפה: צרפתית ✅ | מרחק: 12 ק"מ | מין: מתנדבת ✅"

⚠️ העדפת מין לא מתאימה:
"שפה: ספרדית ✅ | עיר: חיפה ✅ | מין: ⚠️ העדפה מתנדבת"
```

### תנאים לסינון התאמות

המערכת **לא תציע** התאמה אם:
1. ❌ **מרחק בין הערים > 80 ק"מ**
2. ❌ ציון מתחת ל-60 (ברירת מחדל)
3. ❌ ציון < 70 ואין שפת אם משותפת ואין קרבה גיאוגרפית (עד 30 ק"מ)
4. ❌ המתנדב לא פעיל (`is_active = false`)
5. ❌ המתנדב לא במלגה פעילה (`scholarship_active = false`)
6. ❌ למתנדב אין מקום (`current_students >= capacity_max`)
7. ❌ לחייל כבר יש 3 הצעות התאמה פתוחות
8. ❌ למתנדב כבר יש 5 הצעות התאמה פתוחות

---

## 🌍 שלב 4: חישוב מרחקים

### 🆕 מערכת מרחקים מדורגת (חדש!)

המערכת כוללת **טבלת ערים עם קואורדינטות מדויקות** לחישוב מרחקים אוטומטי.

### דירוג מרחקים - נקודות

| דירוג | מרחק | נקודות | דוגמאות |
|-------|------|--------|---------|
| 🟢 **דירוג 1** | אותה עיר / עד 15 ק"מ | **40 נקודות** | תל אביב ↔ רמת גן |
| 🔵 **דירוג 2** | עד 30 ק"מ | **30 נקודות** | תל אביב ↔ פתח תקווה |
| 🟡 **דירוג 3** | עד 50 ק"מ | **20 נקודות** | תל אביב ↔ נתניה |
| 🟠 **דירוג 4** | עד 80 ק"מ | **10 נקודות** | תל אביב ↔ חיפה |
| 🔴 **מחוץ לטווח** | מעל 80 ק"מ | **לא מותאם** | תל אביב ↔ אילת |

### איך המערכת מחשבת מרחק?

```
1. חיפוש בטבלת cities
   ↓
2. שליפת קואורדינטות (latitude, longitude)
   ↓
3. חישוב Haversine
   ↓
4. דירוג לפי טבלת המרחקים
```

### נוסחת Haversine

```
מרחק (ק"מ) = 2 × R × arcsin(√(sin²(Δlat/2) + cos(lat1) × cos(lat2) × sin²(Δlon/2)))

R = 6371 ק"מ (רדיוס כדור הארץ)
```

### 🏙️ ערים נתמכות (56 ערים)

<details>
<summary>לחץ לצפייה ברשימה המלאה</summary>

#### מרכז (16 ערים)
| עיר | קואורדינטות |
|-----|-------------|
| תל אביב | 32.0853, 34.7818 |
| רמת גן | 32.0680, 34.8248 |
| גבעתיים | 32.0717, 34.8108 |
| בני ברק | 32.0833, 34.8333 |
| חולון | 32.0158, 34.7794 |
| בת ים | 32.0171, 34.7517 |
| ראשון לציון | 31.9730, 34.7925 |
| פתח תקווה | 32.0866, 34.8875 |
| רחובות | 31.8928, 34.8113 |
| נס ציונה | 31.9314, 34.7989 |
| לוד | 31.9514, 34.8953 |
| רמלה | 31.9275, 34.8625 |
| מודיעין | 31.8979, 35.0104 |
| יבנה | 31.8681, 34.7394 |
| אור יהודה | 32.0306, 34.8556 |
| קריית אונו | 32.0633, 34.8553 |

#### שרון (6 ערים)
| עיר | קואורדינטות |
|-----|-------------|
| הרצליה | 32.1653, 34.8461 |
| רמת השרון | 32.1467, 34.8397 |
| נתניה | 32.3286, 34.8575 |
| רעננה | 32.1836, 34.8706 |
| כפר סבא | 32.1750, 34.9078 |
| הוד השרון | 32.1500, 34.8917 |
| חדרה | 32.4344, 34.9200 |

#### ירושלים (4 ערים)
| עיר | קואורדינטות |
|-----|-------------|
| ירושלים | 31.7683, 35.2137 |
| בית שמש | 31.7469, 34.9878 |
| מעלה אדומים | 31.7767, 35.3008 |
| גבעת זאב | 31.8617, 35.1706 |

#### צפון (17 ערים)
| עיר | קואורדינטות |
|-----|-------------|
| חיפה | 32.7940, 34.9896 |
| קריית ביאליק | 32.8333, 35.0833 |
| קריית מוצקין | 32.8394, 35.0767 |
| קריית ים | 32.8431, 35.0675 |
| קריית אתא | 32.8000, 35.1000 |
| עכו | 32.9333, 35.0833 |
| נהריה | 33.0050, 35.0975 |
| כרמיאל | 32.9136, 35.3003 |
| עפולה | 32.6069, 35.2917 |
| נצרת | 32.6992, 35.3033 |
| נצרת עילית | 32.7261, 35.3267 |
| טבריה | 32.7936, 35.5314 |
| צפת | 32.9658, 35.4983 |
| קריית שמונה | 33.2081, 35.5711 |
| בית שאן | 32.5017, 35.4969 |
| מגדל העמק | 32.6761, 35.2406 |
| יקנעם | 32.6583, 35.1097 |

#### דרום (11 ערים)
| עיר | קואורדינטות |
|-----|-------------|
| באר שבע | 31.2518, 34.7913 |
| אשדוד | 31.8044, 34.6553 |
| אשקלון | 31.6689, 34.5742 |
| קריית גת | 31.6100, 34.7642 |
| שדרות | 31.5250, 34.5981 |
| נתיבות | 31.4208, 34.5892 |
| אופקים | 31.3158, 34.6178 |
| דימונה | 31.0697, 35.0328 |
| ערד | 31.2544, 35.2128 |
| אילת | 29.5577, 34.9519 |
| מצפה רמון | 30.6108, 34.8019 |

#### שומרון (3 ערים)
| עיר | קואורדינטות |
|-----|-------------|
| אריאל | 32.1050, 35.1747 |
| אום אל-פחם | 32.5194, 35.1528 |
| באקה אל-גרבייה | 32.4167, 35.0500 |

#### ערים נוספות (15 ערים חדשות!)
| עיר | קואורדינטות | אזור |
|-----|-------------|------|
| שורש | 31.8167, 35.0167 | ירושלים |
| אור עקיבא | 32.5083, 34.9181 | שרון |
| יהוד | 32.0347, 34.8889 | מרכז |
| גבעת שמואל | 32.0833, 34.8500 | מרכז |
| כפר יונה | 32.3197, 34.9350 | שרון |
| קריית מלאכי | 31.7308, 34.7500 | דרום |
| עראבה | 32.8500, 35.3333 | צפון |
| סחנין | 32.8639, 35.2953 | צפון |
| טייבה | 32.2667, 35.0000 | שרון |
| טירה | 32.2333, 34.9500 | שרון |
| כפר קאסם | 32.1167, 34.9833 | מרכז |
| פרדס חנה-כרכור | 32.4722, 34.9694 | שרון |
| זכרון יעקב | 32.5694, 34.9531 | שרון |
| קיסריה | 32.5000, 34.8833 | שרון |
| בנימינה | 32.5167, 34.9500 | שרון |
| אלעד | 32.0522, 34.9511 | מרכז |
| ביתר עילית | 31.6939, 35.1203 | ירושלים |

</details>

### ⚠️ עיר לא ברשימה?

אם עיר לא נמצאת ברשימה, המערכת:
1. משווה שמות ערים (case-insensitive)
2. אם אותו שם → מרחק = 0
3. אם שם שונה → לא מותאם (מעל 80 ק"מ)

---

## 🔍 כלים לזיהוי ותיקון ערים בעייתיות

### 1. בדיקת סטטוס כל הערים
```sql
SELECT * FROM city_status;
```

תוצאה לדוגמה:
```
table_name | city      | record_count | status
-----------+-----------+--------------+-------------
students   | תל אביב   | 25           | ✅ מזוהה
students   | Tel Aviv  | 10           | ✅ מזוהה
students   | תל-אביב   | 5            | ✅ מזוהה
users      | NETANYA   | 3            | ✅ מזוהה
students   | תל אבייב  | 2            | ❌ לא מזוהה  ← בעיה!
```

### 2. מציאת ערים לא מזוהות
```sql
SELECT * FROM find_unrecognized_cities();
```

תוצאה:
```
city_name    | source_table | count
-------------+--------------+-------
תל אבייב     | students     | 2
נתניא        | users        | 1
```

### 3. תיקון אוטומטי של ערים
```sql
SELECT * FROM fix_city_names();
```

הפונקציה תתקן אוטומטית ערים שיש להן כינוי מוכר:
```
table_name | original_city | normalized_city | records_updated
-----------+---------------+-----------------+-----------------
students   | tel aviv      | תל אביב         | 5
users      | NETANYA       | נתניה           | 3
```

### 4. הוספת עיר חדשה
```sql
INSERT INTO cities (name, name_normalized, aliases, region, latitude, longitude)
VALUES ('שם העיר', 'שם העיר', ARRAY['כינוי1', 'כינוי2'], 'אזור', 32.XXXX, 34.XXXX);
```

### 5. הוספת כינוי לעיר קיימת
```sql
UPDATE cities 
SET aliases = array_append(aliases, 'כינוי חדש')
WHERE name = 'שם העיר';
```

### 6. נרמול שם עיר בודד
```sql
SELECT normalize_city_name('tel aviv');
-- מחזיר: תל אביב
```

---

## 📋 תהליך עבודה מומלץ לייבוא נתונים

```
┌─────────────────────────────────────────────────────────────┐
│                  לפני ייבוא נתונים                          │
├─────────────────────────────────────────────────────────────┤
│ 1. בדוק את רשימת הערים ב-Excel                             │
│ 2. תקן שגיאות כתיב ברורות                                  │
│ 3. ודא שימוש עקבי (עברית או אנגלית)                         │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│                    ייבוא הנתונים                            │
│              (import-excel function)                        │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│                  אחרי ייבוא נתונים                          │
├─────────────────────────────────────────────────────────────┤
│ 1. הרץ: SELECT * FROM city_status;                         │
│ 2. בדוק ערים עם ❌ לא מזוהה                                │
│ 3. אם יש כאלה:                                              │
│    א. הוסף כינוי לעיר קיימת, או                            │
│    ב. הוסף עיר חדשה עם קואורדינטות                         │
│ 4. הרץ: SELECT * FROM fix_city_names();                     │
│ 5. עכשיו הרץ את סריקת ההתאמות                               │
└─────────────────────────────────────────────────────────────┘
```

---

## 🚨 דוגמאות לשגיאות נפוצות ותיקונן

| שגיאה | סוג הבעיה | פתרון |
|-------|-----------|--------|
| `תל אבייב` | שגיאת כתיב | הוסף ככינוי: `UPDATE cities SET aliases = array_append(aliases, 'תל אבייב') WHERE name = 'תל אביב';` |
| `ת.א.` | קיצור לא מוכר | הוסף ככינוי: `UPDATE cities SET aliases = array_append(aliases, 'ת.א.') WHERE name = 'תל אביב';` |
| `כפר-סבה` | מקף במקום רווח | כבר מוכר ✅ |
| `TELAVIV` | ללא רווח | הוסף ככינוי: `UPDATE cities SET aliases = array_append(aliases, 'TELAVIV') WHERE name = 'תל אביב';` |
| `עיר חדשה` | עיר לא קיימת | הוסף עיר חדשה עם קואורדינטות |

---

## ⚙️ שלב 5: הגדרות מערכת

### הגדרות ניקוד

| הגדרה | ערך ברירת מחדל | תיאור |
|-------|----------------|-------|
| `language_match_points` | 60 | נקודות לשפת אם זהה |
| `gender_match_points` | 15 | נקודות להתאמת מין |
| `special_requests_points` | 5 | נקודות לבקשות מיוחדות |
| `min_match_score` | 60 | ציון מינימלי להצגת התאמה |
| `max_matches_limit` | 100 | מקס' התאמות לכל סריקה |

### 🆕 הגדרות מרחק מדורגות (חדש!)

| הגדרה | ערך | תיאור |
|-------|-----|-------|
| `distance_tier_1_km` | 15 | מרחק דירוג 1 (ק"מ) |
| `distance_tier_1_points` | 40 | נקודות דירוג 1 |
| `distance_tier_2_km` | 30 | מרחק דירוג 2 (ק"מ) |
| `distance_tier_2_points` | 30 | נקודות דירוג 2 |
| `distance_tier_3_km` | 50 | מרחק דירוג 3 (ק"מ) |
| `distance_tier_3_points` | 20 | נקודות דירוג 3 |
| `distance_tier_4_km` | 80 | מרחק דירוג 4 (ק"מ) |
| `distance_tier_4_points` | 10 | נקודות דירוג 4 |
| `max_distance_km` | 80 | מרחק מקסימלי מוחלט |

### איך לשנות הגדרות

ב-Supabase Dashboard או דרך SQL:

```sql
-- שינוי ציון מינימלי
UPDATE settings SET value = '70' WHERE key = 'min_match_score';

-- שינוי מרחק מקסימלי
UPDATE settings SET value = '100' WHERE key = 'max_distance_km';

-- שינוי נקודות שפה
UPDATE settings SET value = '50' WHERE key = 'language_match_points';
```

### צפייה בכל ההגדרות

```sql
SELECT key, value, description FROM settings ORDER BY key;
```

---

## 👁️ שלב 6: אימות התאמות - צפייה בפרטים

### איך לבדוק התאמה?

בטבלת ההתאמות, לחץ על **שם החייל** או **שם המתנדב** כדי לפתוח חלון פרטים מלא.

### מה מוצג בחלון הפרטים?

```
┌─────────────────────────────────────────────────────────────┐
│                    פרטי התאמה - אימות נתונים                 │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ציון התאמה: 85%                                            │
│  סיבה: שפת אם זהה (רוסית) • אותה עיר (תל אביב)              │
│                                                              │
├───────────────────────┬─────────────────────────────────────┤
│      חייל/ת           │           מתנדב/ת                   │
├───────────────────────┼─────────────────────────────────────┤
│ שם: דוד כהן           │ שם: אלכסנדר לוי                    │
│ מזהה: abc123...       │ מזהה: def456...                    │
│ אימייל: david@...     │ אימייל: alex@...                   │
│ טלפון: 050-1234567    │ טלפון: 052-7654321                 │
│ ───────────────────── │ ─────────────────────────────────── │
│ עיר: תל אביב    ✅    │ עיר: תל אביב    ✅                 │
│ שפת אם: רוסית  ✅    │ שפת אם: רוסית  ✅                  │
│ מין: זכר       ✅    │ מין: זכר       ✅                  │
│ ───────────────────── │ ─────────────────────────────────── │
│ חיל: חי"ר             │ קיבולת: 1/2 חיילים                 │
│ מקום שירות: צפון      │ פעיל במלגה: ✅ כן                  │
│                       │ פעיל במערכת: ✅ כן                 │
└───────────────────────┴─────────────────────────────────────┘

        סיכום אימות התאמה
┌──────────┬──────────┬──────────┬──────────────┐
│ שפת אם   │   עיר    │   מין    │ קיבולת פנויה │
│   ✅     │   ✅     │   ✅     │     ✅       │
└──────────┴──────────┴──────────┴──────────────┘

        [  אשר התאמה  ]    [  דחה התאמה  ]
```

### סימונים בחלון הפרטים

| סימון | משמעות |
|-------|--------|
| ✅ (רקע ירוק) | הערכים תואמים |
| ❌ (רקע אדום) | הערכים לא תואמים |
| ❓ (רקע אפור) | לא ניתן לבדוק (ערך חסר) |

### שיוך מזהה לשם

בטבלת ההתאמות, מתחת לכל שם מוצג חלק מהמזהה (UUID):
```
דוד כהן
abc12345...
```

זה מאפשר לזהות את הרשומה גם לפי המזהה הייחודי.

---

## 📊 שלב 7: סטטוסי התאמה

| סטטוס | משמעות | מה קורה אחר כך |
|-------|--------|----------------|
| `Suggested` | הצעה חדשה | ממתין לאישור/דחייה |
| `Approved` | התאמה אושרה | מעדכן `current_students` של המתנדב |
| `Rejected` | התאמה נדחתה | נשאר בהיסטוריה, לא מוצע שוב |

---

## 📤 שלב 8: ייצוא התאמות ל-CSV

### כפתור ייצוא

בטבלת ההתאמות יש כפתור **"ייצא CSV"** שמייצא את כל ההתאמות המוצגות לקובץ.

### עמודות בקובץ CSV

| עמודה | תיאור |
|-------|-------|
| מזהה התאמה | UUID |
| שם חייל | שם מלא |
| טלפון חייל | מספר טלפון |
| אימייל חייל | כתובת אימייל |
| עיר חייל | עיר מגורים |
| שפת אם חייל | שפה |
| בקשות מיוחדות | טקסט הבקשה |
| שם מתנדב | שם מלא |
| טלפון מתנדב | מספר טלפון |
| אימייל מתנדב | כתובת אימייל |
| עיר מתנדב | עיר מגורים |
| שפת אם מתנדב | שפה |
| קיבולת מתנדב | X/Y חיילים |
| ציון התאמה | אחוזים |
| סיבת התאמה | תיאור מפורט |
| סטטוס | Suggested/Approved/Rejected |

### תכונות הייצוא

- ✅ תמיכה מלאה בעברית (BOM)
- ✅ שם קובץ אוטומטי: `התאמות_YYYY-MM-DD.csv`
- ✅ טיפול נכון בפסיקים וגרשיים
- ✅ ניתן לפתוח ישירות ב-Excel

---

## ⚠️ שלב 9: בקשות מיוחדות

### צפייה בבקשות מיוחדות

כאשר לחייל יש בקשות מיוחדות, מופיע **כפתור צהוב** בטבלת ההתאמות:

```
┌────────────────────────────────────────┐
│ סיבת התאמה                             │
├────────────────────────────────────────┤
│ שפה: רוסית ✅ | עיר: ירושלים ✅        │
│ ⚠️ [ראה בקשה מיוחדת]  ← כפתור צהוב    │
└────────────────────────────────────────┘
```

לחיצה על הכפתור פותחת חלונית עם:
- שם החייל
- טקסט הבקשה המיוחדת המלא

### איך בקשות מיוחדות משפיעות על הציון?

המערכת בודקת אם הבקשה המיוחדת מכילה:
1. את שפת האם של המתנדב
2. את המילה "דובר"

אם כן → +5 נקודות להתאמה

---

## 🔄 שלב 10: תרשים זרימה מלא

```
┌─────────────────────────────────────────────────────────────────┐
│                         העלאת Excel                             │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    פונקציית import-excel                        │
│  ─────────────────────────────────────────────────────────────  │
│  1. קריאת הנתונים מה-JSON                                       │
│  2. מיפוי עמודות עבריות → שדות DB                               │
│  3. יצירת email אוטומטי אם חסר                                  │
│  4. בדיקת כפילויות (email/phone/contact_id)                    │
│  5. הכנסה לטבלה המתאימה                                         │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│              students (חיילים)  │  users (מתנדבים)              │
│              is_matched=false   │  is_active=true              │
│                                 │  scholarship_active=true     │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                   לחיצה על "סרוק התאמות"                        │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                  פונקציית generate-matches                      │
│  ─────────────────────────────────────────────────────────────  │
│  1. טעינת כל החיילים שלא שובצו (is_matched=false)              │
│  2. טעינת כל המתנדבים הפעילים עם מקום פנוי                      │
│  3. לולאה על כל זוג אפשרי:                                      │
│     a. חישוב מרחק (Haversine או השוואת שם עיר)                  │
│     b. חישוב ציון התאמה                                         │
│     c. סינון לפי ציון מינימלי                                   │
│  4. מיון לפי ציון (גבוה לנמוך)                                  │
│  5. הקצאה חמדנית (greedy) - הכי טובים קודם                      │
│  6. הכנסה לטבלת matches בסטטוס Suggested                        │
│  7. רישום לhistory                                              │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      טבלת matches                               │
│  ─────────────────────────────────────────────────────────────  │
│  student_id  │  user_id  │  score  │  reason  │  status        │
│  ──────────  │  ───────  │  ─────  │  ──────  │  ───────       │
│  uuid...     │  uuid...  │  95     │  שפה+עיר │  Suggested     │
│  uuid...     │  uuid...  │  80     │  שפה     │  Suggested     │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     בדיקה ידנית + אישור                         │
│                   update-match-status                           │
│  ─────────────────────────────────────────────────────────────  │
│  Approved → מעדכן current_students של המתנדב (+1)              │
│  Rejected → נשאר בהיסטוריה                                      │
└─────────────────────────────────────────────────────────────────┘
```

---

## ❓ שאלות נפוצות

### ש: למה אני מקבל 0 התאמות?
**ת:** בדוק:
1. האם יש נתונים בטבלאות `students` ו-`users`?
2. האם למתנדבים `is_active=true` ו-`scholarship_active=true`?
3. האם שמות הערים תואמים?
4. האם שפות האם רשומות באותו אופן?

### ש: איך לתקן ערים שרשומות לא נכון?
**ת:** תקן את קובץ ה-Excel לפני העלאה, או עדכן ישירות בדאטהבייס:
```sql
UPDATE students SET city = 'תל אביב' WHERE city IN ('ת"א', 'תל-אביב', 'תל אביב יפו');
UPDATE users SET city = 'תל אביב' WHERE city IN ('ת"א', 'תל-אביב', 'תל אביב יפו');
```

### ש: איך להוסיף קואורדינטות לערים?
**ת:** הפונקציה `geocode-cities` יכולה לעזור, או הוסף ידנית:
```sql
UPDATE students SET latitude = 32.0853, longitude = 34.7818 WHERE city = 'תל אביב';
```

### ש: למה התאמה עם ציון גבוה לא מופיעה?
**ת:** ייתכן שהמתנדב כבר מלא (הגיע ל-`capacity_max`) או שלחייל/מתנדב כבר יש מספיק הצעות פתוחות.

---

## 📞 תמיכה

אם נתקלת בבעיות:
1. בדוק את הלוגים ב-Supabase Dashboard
2. וודא שכל ההגדרות נכונות
3. בדוק שהנתונים בפורמט הנכון

---

*עודכן לאחרונה: 24 דצמבר 2024*

---

## 📝 סיכום שינויים אחרונים

### גרסה אחרונה (24/12/2024)

| תכונה | תיאור |
|-------|-------|
| **העדפת מין חכמה** | כאשר החייל מציין "לא חשוב" - המערכת לא בודקת התאמת מין |
| **תיאור התאמה מורחב** | שפות האם של שני הצדדים מוצגות תמיד בסיבת ההתאמה |
| **כפתור בקשות מיוחדות** | לחיצה על כפתור צהוב מציגה את הבקשה המיוחדת של החייל |
| **ייצוא CSV** | כפתור "ייצא CSV" מייצא את כל ההתאמות עם פרטים מלאים |
| **נרמול ערים משופר** | טיפול בערים מרובות (מופרדות ב-/ או ,), וריאציות שמות |
| **ערים חדשות** | נוספו 15+ ערים ויישובים חדשים עם קואורדינטות |
| **כינויים נוספים** | תל אביב יפו, NETANYA, Herzliya, Givatayim ועוד |

